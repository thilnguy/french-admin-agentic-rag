# ============================================================================
# Topic Registry — Single Source of Truth for Agent Decision Rules
# ============================================================================
# This file centralizes all topic-specific rules that were previously
# scattered across orchestrator.py, procedure_agent.py, and guardrails.py.
#
# HOW IT WORKS:
# 1. IntentClassifier determines the broad intent (SIMPLE_QA, COMPLEX_PROCEDURE, etc.)
# 2. TopicDetector maps the query to a topic key from this file
# 3. Only the RELEVANT topic's rules are injected into the prompt
#
# ADDING A NEW TOPIC:
# Just add a new entry below. No need to touch any prompt strings.
# ============================================================================

topics:
  immigration:
    display_name: "Immigration & Visa"
    description: "Visa renewals, residence permits, family reunification, naturalization, Passeport Talent"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: nationality
        why: "Determines EU/Non-EU pathway and applicable bilateral agreements"
      - name: visa_type
        why: "Different visa types have completely different renewal procedures"
      - name: family_situation
        why: "Required for 10-year residence card and family reunification"
      - name: years_of_residence
        why: "Eligibility thresholds differ (3 vs 5 vs 10 years)"
    conditional_variables:
      - name: contract_extension_proof
        when: "Passeport Talent renewal"
        why: "Convention d'accueil is mandatory for researcher visa renewal"
      - name: expiry_date
        when: "Any renewal"
        why: "Must renew 2 months before expiration"
    exemplars:
      - input: "Comment renouveler mon passeport talent 'chercheur' ?"
        output: |
          **[DONNER]**: Vous devez demander le renouvellement 2 mois avant l'expiration.
          **[EXPLIQUER]**: La procédure nécessite une convention d'accueil signée.
          **[DEMANDER]**: Avez-vous votre convention d'accueil signée par votre employeur ?
      - input: "Tôi muốn đăng ký thẻ cư trú 10 năm sau khi đã ở Pháp 3 năm với diện Passeport Talent."
        output: |
          **[CUNG CẤP]**: Thẻ 10 năm thường yêu cầu 5 năm cư trú, nhưng Passeport Talent có điều kiện riêng.
          **[GIẢI THÍCH]**: Bạn cần kiểm tra diện đóng góp đặc biệt hoặc có gia đình là người Pháp.
          **[YÊU CẦU]**: Tình trạng gia đình của bạn như thế nào? Bạn đã ở Pháp bao nhiêu năm chính xác?
    guardrail_keywords:
      fr: ["visa", "titre de séjour", "passeport talent", "naturalisation", "regroupement familial", "carte de résident"]
      en: ["visa", "residence permit", "naturalization", "family reunification"]
      vi: ["thẻ cư trú", "visa", "quốc tịch"]

  labor:
    display_name: "Work & Labor Rights"
    description: "Employment disputes, unpaid wages, chômage technique, strikes, employer conflicts"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: contract_type
        why: "CDI vs CDD affects rights and procedures significantly"
      - name: company_size
        why: "Mandatory for chômage technique eligibility and thresholds"
      - name: proof_of_hours
        why: "Essential evidence for unpaid wage disputes (Prud'hommes)"
    conditional_variables:
      - name: region
        when: "Strike-related queries"
        why: "Compensation varies by affected region and transport line"
      - name: line_used
        when: "Transport strike refund"
        why: "Determines eligibility for Navigo refund"
      - name: period_of_strike
        when: "Strike refund"
        why: "Must match IDFM's declared refund period"
    # CRITICAL FACTUAL RULE — DO NOT CONTRADICT
    factual_rules:
      - topic: "strike pay"
        rule: "During a legal strike, an employer IS LEGALLY ALLOWED to withhold salary for hours not worked. This is the correct French legal position (Article L2511-1 Code du Travail). Do NOT state the opposite."
        keywords: ["grève", "strike", "salaire grève", "retenue salaire"]
    exemplars:
      - input: "Mon employeur ne me paie pas mes heures supplémentaires, que faire ?"
        output: |
          **[DONNER]**: Envoyez une mise en demeure par LRAR à votre employeur.
          **[EXPLIQUER]**: Si cela échoue, vous pouvez saisir les Prud'hommes.
          **[DEMANDER]**: Quel est votre type de contrat (CDI/CDD) ? Avez-vous des preuves de présence ?
      - input: "What are the rules for 'chômage technique' during a flood?"
        output: |
          **[GIVE]**: The employer can trigger 'activité partielle'. Employees receive ~70% of gross salary.
          **[EXPLAIN]**: The state compensates the employer via a specific mechanism.
          **[ASK]**: What is the size of your company? In which region are you located?
      - input: "Em là người tị nạn và đang làm việc mà không có hợp đồng. Em có thể yêu cầu tiền lương chưa được trả không?"
        output: |
          **[CUNG CẤP]**: Có, bạn có quyền yêu cầu tiền lương chưa được trả dù không có hợp đồng chính thức, vì quyền lao động áp dụng cho tất cả mọi người.
          **[GIẢI THÍCH]**: Bạn có thể nộp khiếu nại lên Prud'hommes. Tình trạng tị nạn không ảnh hưởng đến quyền đòi lương.
          **[YÊU CẦU]**: Bạn có bằng chứng về số giờ đã làm (tin nhắn, email, nhân chứng) không? Quy mô công ty như thế nào?
      - input: "Je participe à une grève mais mon employeur menace de ne pas payer mes heures."
        output: |
          **[DONNER]**: En cas de grève légale, l'employeur PEUT légalement retenir le salaire des heures non travaillées — c'est la règle du droit français (Art. L2511-1 du Code du Travail).
          **[EXPLIQUER]**: La retenue de salaire est proportionnelle aux heures d'absence dues à la grève, pas aux heures travaillées. Certains accords de branche prévoient des compensations.
          **[DEMANDER]**: Quel est votre type de contrat ? Avez-vous un accord de branche ou une convention collective ?
    guardrail_keywords:
      fr: ["employeur", "heures supplémentaires", "Prud'hommes", "chômage technique", "grève", "retenue salaire", "activité partielle"]
      en: ["strike", "partial activity", "unpaid wages", "employer dispute"]
      vi: ["tiền lương", "hợp đồng lao động", "lương", "khiếu nại", "làm việc"]

  taxes:
    display_name: "Taxes & Fiscal"
    description: "Income tax, donations, inheritance, IFI, local taxes, tax credits"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: annual_income
        why: "Determines tax bracket and eligibility for deductions/credits"
      - name: fiscal_residence
        why: "France vs abroad changes the entire tax regime"
      - name: family_composition
        why: "Number of parts fiscales affects calculation significantly"
    conditional_variables:
      - name: amount
        when: "Donations/gifts"
        why: "100,000€ per child per 15 years is the tax-free threshold"
      - name: last_donation_date
        when: "Donations/gifts"
        why: "15-year cycle determines if abattement is available"
      - name: child_age
        when: "Childcare tax credit"
        why: "Only children under 6 qualify for the credit"
    exemplars:
      - input: "Tôi muốn tặng tiền cho con cái, có phải nộp thuế không?"
        output: |
          **[CUNG CẤP]**: Bạn có thể tặng tối đa 100.000€ mỗi 15 năm không thuế cho mỗi con.
          **[GIẢI THÍCH]**: Trên mức đó sẽ bị đánh thuế theo biểu thuế luỹ tiến.
          **[YÊU CẦU]**: Số tiền bạn muốn tặng là bao nhiêu? Lần tặng gần nhất là khi nào?
      - input: "Est-ce que je peux déduire les frais de garde d'enfants de mes impôts ?"
        output: |
          **[DONNER]**: Oui, un crédit d'impôt existe pour les frais de garde hors domicile.
          **[EXPLIQUER]**: Le plafond est de 3 500€ par enfant et s'applique aux enfants de moins de 6 ans.
          **[DEMANDER]**: Quel est l'âge de votre enfant ? Quel est le montant total des frais de garde ?
    guardrail_keywords:
      fr: ["impôts", "donation", "succession", "IFI", "crédit d'impôt", "héritage"]
      en: ["tax", "donation", "inheritance", "tax credit"]
      vi: ["thuế", "tặng tiền", "thừa kế"]

  identity:
    display_name: "Identity & Civil Registry"
    description: "Passports, ID cards, birth registration, marriage, lost documents, criminal records"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: place_of_birth
        why: "Determines which Mairie handles the registration"
      - name: marital_status
        why: "Affects required documents for birth/marriage registration"
      - name: emergency_level
        why: "Determines if consulate can assist remotely or requires in-person visit"
    conditional_variables:
      - name: type_of_offense
        when: "Criminal record (Casier Judiciaire)"
        why: "Determines automatic expiry timeline"
      - name: time_passed
        when: "Criminal record"
        why: "Some records expire automatically after a set period"
    exemplars:
      - input: "How do I register a birth in France?"
        output: |
          **[GIVE]**: Declare within 5 days at the Mairie of the place of birth.
          **[EXPLAIN]**: You need the doctor's certificate and parents' ID.
          **[ASK]**: Where was the birth? What is the parents' marital status?
      - input: "Tôi bị mất hộ chiếu Việt Nam tại Nice, tôi có phải lên Paris không?"
        output: |
          **[CUNG CẤP]**: Bạn cần trình báo cảnh sát Pháp tại Nice trước.
          **[GIẢI THÍCH]**: Sau đó liên hệ ĐSQ tại Paris. ĐSQ có thể hỗ trợ qua bưu điện tùy trường hợp.
          **[YÊU CẦU]**: Mức độ khẩn cấp như thế nào? Bạn có cần hộ chiếu ngay để đi lại không?
    guardrail_keywords:
      fr: ["passeport", "naissance", "casier judiciaire", "mariage", "carte d'identité", "carte de résident", "titre de voyage"]
      en: ["passport", "birth", "criminal record", "identity", "marriage", "refugee card"]
      vi: ["hộ chiếu", "kết hôn", "giấy khai sinh"]

  social:
    display_name: "Social Benefits & Welfare"
    description: "AAH, RSA, Chèque Énergie, retirement, disability, housing aid (CAF)"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: income_level
        why: "Most social benefits are means-tested"
      - name: disability_percentage
        why: "AAH requires minimum 80% disability (or 50-79% with work restriction)"
      - name: age
        why: "Determines retirement eligibility and specific benefit thresholds"
    conditional_variables:
      - name: income_declared
        when: "Chèque Énergie"
        why: "Attributed automatically based on declared tax income"
      - name: employment_status
        when: "RSA, AAH"
        why: "Working while receiving benefits affects calculation"
    exemplars:
      - input: "Tôi muốn xin trợ cấp AAH nhưng tôi đang đi làm."
        output: |
          **[CUNG CẤP]**: AAH có thể kết hợp với thu nhập từ việc làm nhưng sẽ bị khấu trừ.
          **[GIẢI THÍCH]**: Bạn cần khai báo thu nhập hàng quý (DTR).
          **[YÊU CẦU]**: Thu nhập hàng quý của bạn là bao nhiêu? Tỷ lệ khuyết tật?
      - input: "Comment obtenir le 'Chèque Énergie' ?"
        output: |
          **[DONNER]**: Le chèque énergie est attribué automatiquement selon vos revenus déclarés aux impôts.
          **[EXPLIQUER]**: Il n'y a pas de démarche à faire. Si vous y avez droit, il sera envoyé à votre domicile.
          **[DEMANDER]**: Avez-vous déclaré vos revenus aux impôts cette année ?
      - input: "Comment faire ma demande de retraite si j'ai travaillé à l'étranger ?"
        output: |
          **[DONNER]**: La France a des accords avec de nombreux pays pour la totalisation des périodes.
          **[EXPLIQUER]**: Vous devez déclarer vos périodes travaillées via le formulaire E202 (Europe) ou selon la convention bilatérale.
          **[DEMANDER]**: Dans quels pays avez-vous travaillé ? Quel est votre âge actuel ?
    guardrail_keywords:
      fr: ["AAH", "RSA", "chèque énergie", "retraite", "CAF", "allocation"]
      en: ["disability benefit", "retirement", "social benefit"]
      vi: ["trợ cấp", "hưu trí", "khữu tật"]

  health:
    display_name: "Healthcare & Insurance"
    description: "Health insurance, carte vitale, cross-border workers (Frontalier), CPAM, dual nationals"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: residence_location
        why: "Determines if French or foreign health system applies"
      - name: employment_status
        why: "Salaried vs self-employed vs student → different registration"
      - name: job_type
        why: "Cross-border (Frontalier) status enables S1 form"
    exemplars:
      - input: "Can I keep my French health insurance if I move to Germany?"
        output: |
          **[GIVE]**: Cross-border workers can retain French insurance via the S1 form.
          **[EXPLAIN]**: If you fully relocate, you switch to the German system (SGB).
          **[ASK]**: Will you reside in France and work in Germany (Frontalier)?
      - input: "Tôi làm việc bán thời gian, bảo hiểm y tế có khác không?"
        output: |
          **[CUNG CẤP]**: Có, người làm việc bán thời gian có thể được hưởng bảo hiểm y tế Pháp (Sécurité Sociale) nếu làm đủ điều kiện.
          **[GIẢI THÍCH]**: Điều kiện phụ thuộc vào số giờ làm việc, nơi cư trú và loại hợp đồng. Người làm bán thời gian xuyên biên giới có thể cần form S1.
          **[YÊU CẦU]**: Bạn cư trú ở Pháp hay nước khác? Bạn là nhân viên theo hợp đồng hay tự kinh doanh?
      - input: "Can dual nationals access healthcare in both countries seamlessly?"
        output: |
          **[GIVE]**: Dual nationals typically use the health system of their country of residence. France uses the Sécurité Sociale system.
          **[EXPLAIN]**: Cross-border arrangements (like the S1 form) may allow some dual coverage, but this depends on your employment location and bilateral agreements.
          **[ASK]**: Where do you currently reside? Are you employed in France or abroad?
    guardrail_keywords:
      fr: ["assurance maladie", "carte vitale", "CPAM", "frontalier", "sécurité sociale"]
      en: ["health insurance", "S1 form", "cross-border healthcare", "dual national healthcare"]
      vi: ["bảo hiểm y tế", "sức khỏe", "bảo hiểm", "y tế"]

  housing:
    display_name: "Housing & Tenant Rights"
    description: "Tenant eviction, building permits, landlord disputes, trêve hivernale"
    default_step: CLARIFICATION
    mandatory_variables:
      - name: has_court_order
        why: "Eviction requires judicial process"
      - name: current_month
        why: "Trêve hivernale protects tenants Nov-Mar"
    conditional_variables:
      - name: pool_size
        when: "Building permits for pools"
        why: "Determines if déclaration préalable or permis de construire needed"
      - name: location
        when: "Building permits"
        why: "Local PLU rules vary significantly"
    exemplar:
      input: "Tôi bị chủ nhà đuổi ra khỏi nhà ngay lập tức, họ có quyền không?"
      output: |
        **[CUNG CẤP]**: Không, chủ nhà phải tuân thủ quy trình tòa án.
        **[GIẢI THÍCH]**: Có Trêve hivernale cấm trục xuất từ tháng 11 đến tháng 3.
        **[YÊU CẦU]**: Hiện tại là tháng mấy? Bạn có nhận được lệnh tòa không?
    guardrail_keywords:
      fr: ["logement", "loyer", "locataire", "propriétaire", "expulsion", "permis de construire", "trêve hivernale"]
      en: ["housing", "tenant", "landlord", "eviction", "building permit"]
      vi: ["chủ nhà", "tiền thuê", "xuất cư"]

  daily_life:
    display_name: "Daily Life & Transport"
    description: "Navigo pass, driving licenses, vehicle registration, school insurance, Crit'Air"
    default_step: RETRIEVAL  # Mostly factual answers
    mandatory_variables:
      - name: activity_type
        why: "Assurance scolaire mandatory only for extracurricular activities"
    conditional_variables:
      - name: line_used
        when: "Navigo refund"
        why: "Must match affected area"
      - name: period_of_strike
        when: "Navigo refund"
        why: "Must match IDFM declared period"
      - name: license_category
        when: "Driving license questions"
        why: "B-license vs C/D determines commercial driving eligibility"
      - name: former_country
        when: "Driving license exchange"
        why: "France only exchanges licenses from specific non-EU countries"
    exemplars:
      - input: "I have a UK driving license and live in France. Do I need to exchange it?"
        output: |
          **[GIVE]**: You may need to exchange your license if you reside in France for more than one year.
          **[EXPLAIN]**: The rules depend on whether the UK license was issued before or after Brexit and your residency status.
          **[ASK]**: When did you move to France? Did you obtain your license before Jan 2021?
    guardrail_keywords:
      fr: ["Navigo", "permis de conduire", "assurance scolaire", "Crit'Air", "SNCF", "RATP", "carte grise"]
      en: ["driving license", "school insurance", "vehicle registration"]
      vi: ["bằng lái xe", "bảo hiểm học đưởng"]

  education:
    display_name: "Education & Student Affairs"
    description: "School registration, student permits, university admin, student work rights, scholarships"
    default_step: RETRIEVAL  # Student work rights are fact-based
    mandatory_variables: []
    force_retrieval_patterns:
      - "student work"
      - "étudiant travailler"
      - "964 hours"
    exemplar:
      input: "Can a student work in France?"
      output: |
        **[GIVE]**: Yes, students can work up to 964 hours per year (60% of full-time).
        **[EXPLAIN]**: This applies to all valid student visa holders.
    guardrail_keywords:
      fr: ["étudiant", "bourse", "université", "inscription scolaire"]
      en: ["student", "scholarship", "university", "student visa"]
      vi: ["sinh viên", "học bổng", "trường đại học"]

# ============================================================================
# PERSONA — Applied to all agent responses
# ============================================================================
persona: "You are a French Administration Assistant. Reason step-by-step before answering. Your goal is to provide accurate, grounded, and helpful information based ONLY on the provided Context and History."

# ============================================================================
# GLOBAL RULES — Simplified and Consolidated
# ============================================================================
global_rules:
  response_structure:
    - "Always include 3 blocks: [DONNER], [EXPLIQUER], [DEMANDER]"
    - "Respond entirely in the user's detected language with localized tags"
    - "[DONNER]: Mandatary. Provide a direct answer or a summary of the general procedure."
    - "[EXPLIQUER]: Explain criteria, legal basis, or why the procedure varies."
    - "[DEMANDER]: Ask 2-3 specific TARGETED questions from the topic variables."
  
  grounding:
    - "ONLY cite figures present in context; if none, say 'details depend on your case'"
    - "Never assume nationality or residency status without explicit mention"
    - "Reason step-by-step internally, but only output the 3 blocks above"
  
  questioning_etiquette:
    - "NEVER ask for info already in the User Profile"
    - "NEVER ask generic 'How can I help?' or for personal contact info (email/phone)"
  
  deadline_analysis:
    - "If context mentions a time limit (e.g., renewal 2 months before expiry), compare with user's duration_of_stay"
    - "If remaining time < 3 months, begin [EXPLIQUER] with '⚠️ [URGENT]:'"
  
  external_knowledge:
    - "You may use general geographic knowledge (e.g., Vietnam → Non-EU country, EU/EEE classification)"
    - "You may also use general knowledge about employment law and administrative procedures"
    - "If context clearly contradicts the User Profile, prioritize the User Profile"
