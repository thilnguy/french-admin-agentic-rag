<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marianne AI - Assistant Administratif</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        marianne: {
                            blue: '#000091',
                            red: '#E1000F',
                            neutral: '#161616',
                            soft: '#F6F6F6'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Markdown Styles within AI Chat */
        .markdown-body h1 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 0.5em;
            color: #000091;
        }

        .markdown-body h2 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #161616;
        }

        .markdown-body h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .markdown-body p {
            margin-bottom: 0.8em;
            line-height: 1.6;
        }

        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body strong {
            font-weight: 600;
            color: #000091;
        }

        .markdown-body a {
            color: #000091;
            text-decoration: underline;
        }

        .markdown-body blockquote {
            border-left: 4px solid #000091;
            padding-left: 1em;
            color: #555;
            font-style: italic;
            background: #F6F6F6;
            padding: 0.5em;
            border-radius: 4px;
        }

        .markdown-body code {
            background-color: #f1f1f1;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Typing Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="bg-gray-50 h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div
                        class="bg-marianne-blue text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-md">
                        M
                    </div>
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full">
                    </div>
                </div>
                <div>
                    <h1 class="font-bold text-gray-900 text-lg leading-tight">Marianne AI</h1>
                    <p class="text-xs text-marianne-blue font-medium flex items-center gap-1">
                        <img src="https://upload.wikimedia.org/wikipedia/en/c/c3/Flag_of_France.svg"
                            class="w-4 h-3 inline shadow-sm border border-gray-200">
                        Administration Fran√ßaise
                    </p>
                </div>
            </div>
            <button onclick="toggleSettings()"
                class="text-gray-400 hover:text-marianne-blue transition-colors p-2 rounded-full hover:bg-gray-100">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 scroll-smooth">
        <div class="max-w-3xl mx-auto space-y-6" id="messages-list">

            <!-- Welcome Message -->
            <div class="flex flex-col px-4 py-6 items-center text-center space-y-4 animate-fade-in-up">
                <div class="w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-3xl mb-2">
                    üá´üá∑
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Bonjour ! Comment puis-je vous aider ?</h2>
                <p class="text-gray-600 max-w-md">
                    Je suis Marianne, votre assistante virtuelle pour toutes les d√©marches administratives en France.
                </p>

                <!-- Quick Suggestions (Initial) -->
                <div class="flex flex-wrap justify-center gap-2 mt-4">
                    <button onclick="setQuery('Comment obtenir un passeport ?')"
                        class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:border-marianne-blue hover:text-marianne-blue transition shadow-sm">
                        üõÇ Passeport
                    </button>
                    <button onclick="setQuery('Renouvellement titre de s√©jour')"
                        class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:border-marianne-blue hover:text-marianne-blue transition shadow-sm">
                        ü™™ Titre de s√©jour
                    </button>
                    <button onclick="setQuery('D√©clarer mes imp√¥ts')"
                        class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:border-marianne-blue hover:text-marianne-blue transition shadow-sm">
                        üí∂ Imp√¥ts
                    </button>
                    <button onclick="setQuery('Aide CAF √©tudiant')"
                        class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:border-marianne-blue hover:text-marianne-blue transition shadow-sm">
                        üè† CAF
                    </button>
                </div>
            </div>

        </div>

        <!-- Loading Indicator (Hidden by default) -->
        <div id="loading-indicator" class="hidden max-w-3xl mx-auto mt-4 px-4">
            <div class="flex items-start gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm text-xs font-bold text-marianne-blue shrink-0">
                    AI
                </div>
                <div
                    class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm border border-gray-100 flex items-center space-x-1">
                    <div class="w-2 h-2 bg-marianne-blue rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-marianne-blue rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-marianne-blue rounded-full typing-dot"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-20">
        <div class="max-w-3xl mx-auto w-full">

            <!-- Quick Actions (Dynamic) - Optional to show contextually -->
            <div id="quick-actions" class="flex gap-2 mb-3 overflow-x-auto pb-1 hidden">
                <!-- Example -->
                <!-- <button class="whitespace-nowrap px-3 py-1 bg-blue-50 text-marianne-blue rounded-full text-xs font-semibold hover:bg-blue-100 transition">Oui, je r√©side en France</button> -->
            </div>

            <div
                class="relative flex items-end gap-2 bg-gray-50 border border-gray-300 rounded-2xl p-2 focus-within:ring-2 focus-within:ring-marianne-blue focus-within:border-transparent transition-all shadow-sm">
                <textarea id="user-input" rows="1" placeholder="Posez votre question..."
                    class="w-full bg-transparent border-none text-gray-800 focus:ring-0 resize-none py-2 px-2 max-h-32 placeholder-gray-400"
                    oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>

                <button onclick="sendMessage()" id="send-btn"
                    class="bg-marianne-blue text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-800 transition shadow-sm shrink-0 mb-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <p class="text-center text-xs text-gray-400 mt-2">
                Marianne AI peut faire des erreurs. V√©rifiez toujours les informations officielles.
            </p>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 transform scale-95 transition-transform duration-300"
            id="settings-content">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <h3 class="text-xl font-bold text-gray-900">Param√®tres</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Session ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="session-id" readonly
                            class="w-full bg-gray-100 border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-500 font-mono">
                        <button onclick="refreshSession()"
                            class="text-marianne-blue hover:bg-blue-50 px-3 py-2 rounded-lg border border-gray-200 transition"
                            title="New Session">
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cl√© API (Optionnel)</label>
                    <input type="password" id="api-key" placeholder="Entrez votre cl√© API..."
                        class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-marianne-blue focus:border-marianne-blue outline-none transition"
                        onchange="localStorage.setItem('chat_api_key', this.value)">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Langue pr√©f√©r√©e</label>
                    <select id="user-lang"
                        class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-marianne-blue focus:border-marianne-blue outline-none transition">
                        <option value="fr">Fran√ßais üá´üá∑</option>
                        <option value="en">English üá¨üáß</option>
                        <option value="vi">Ti·∫øng Vi·ªát üáªüá≥</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="toggleSettings()"
                    class="bg-marianne-blue text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-800 transition shadow-md w-full sm:w-auto">
                    Termin√©
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-20 right-4 max-w-sm bg-white border-l-4 border-marianne-red shadow-lg rounded-r-lg p-4 transform translate-x-full transition-transform duration-300 z-50 flex items-start gap-3 hidden">
        <i class="fa-solid fa-circle-exclamation text-marianne-red mt-1"></i>
        <div>
            <h4 class="font-bold text-gray-900 text-sm">Erreur syst√®me</h4>
            <p id="toast-message" class="text-sm text-gray-600 mt-1">Une erreur est survenue.</p>
        </div>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600 ml-auto">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <script>
        // --- State Management ---
        let currentController = null; // For aborting fetching
        const generateUUID = () => Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

        // Initialize
        let sessionId = localStorage.getItem('chat_session_id') || generateUUID();
        let apiKey = localStorage.getItem('chat_api_key') || '';
        document.getElementById('session-id').value = sessionId;
        document.getElementById('api-key').value = apiKey;
        localStorage.setItem('chat_session_id', sessionId); // Persist

        // --- UI Functions ---

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const content = document.getElementById('settings-content');

            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Trigger reflow
                void modal.offsetWidth;
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            } else {
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        function refreshSession() {
            if (confirm("Voulez-vous vraiment commencer une nouvelle conversation ?")) {
                sessionId = generateUUID();
                localStorage.setItem('chat_session_id', sessionId);
                document.getElementById('session-id').value = sessionId;
                document.getElementById('messages-list').innerHTML = `
                <div class="flex flex-col px-4 py-6 items-center text-center space-y-4 animate-fade-in-up">
                    <div class="w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-3xl mb-2">üá´üá∑</div>
                    <h2 class="text-2xl font-bold text-gray-800">C'est reparti !</h2>
                    <p class="text-gray-600">Nouvelle session. Comment puis-je vous aider ?</p>
                </div>`;
                toggleSettings();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto'; // Reset height
            textarea.style.height = textarea.scrollHeight + 'px';
            if (textarea.value === '') textarea.style.height = 'auto';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function setQuery(text) {
            document.getElementById('user-input').value = text;
            autoResize(document.getElementById('user-input'));
            sendMessage();
        }

        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('hidden');
            // Trigger reflow
            void toast.offsetWidth;
            toast.classList.remove('translate-x-full');

            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }

        function appendUserMessage(text) {
            const container = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.className = 'flex justify-end animate-fade-in-up';
            div.innerHTML = `
                <div class="bg-marianne-blue text-white px-5 py-3 rounded-2xl rounded-tr-none shadow-md max-w-[85%] text-sm sm:text-base leading-relaxed">
                    ${text}
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        function appendAIMessage() {
            const container = document.getElementById('messages-list');
            const id = 'msg-' + Math.random().toString(36).substr(2, 9);

            const div = document.createElement('div');
            div.className = 'flex items-start gap-3 animate-fade-in-up';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm text-xs font-bold text-marianne-blue shrink-0 mt-1">
                    M
                </div>
                <div class="bg-white rounded-2xl rounded-tl-none px-6 py-5 shadow-sm border border-gray-100 max-w-full sm:max-w-2xl text-sm sm:text-base markdown-body w-full" id="${id}">
                   <!-- Content will be streamed here -->
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
            return document.getElementById(id);
        }

        function scrollToBottom() {
            const main = document.getElementById('chat-container');
            main.scrollTop = main.scrollHeight;
        }

        // --- Core Logic ---

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const query = input.value.trim();
            const lang = document.getElementById('user-lang').value;
            const loading = document.getElementById('loading-indicator');
            const sendBtn = document.getElementById('send-btn');

            if (!query) return;

            // UI Updates
            input.value = '';
            input.style.height = 'auto'; // Reset height
            input.disabled = true;
            sendBtn.disabled = true;

            appendUserMessage(query);
            loading.classList.remove('hidden');
            scrollToBottom();

            // Prepare for Streaming
            const apiKey = document.getElementById('api-key').value;
            let accumulatedText = "";
            const cleanQuery = encodeURIComponent(query);
            const cleanLang = encodeURIComponent(lang);
            const cleanSession = encodeURIComponent(sessionId);
            const cleanApiKey = encodeURIComponent(apiKey);

            // Event Source (GET request for SSE)
            const url = `http://localhost:8000/chat/stream?query=${cleanQuery}&user_lang=${cleanLang}&session_id=${cleanSession}&api_key=${cleanApiKey}`;

            try {
                // We use fetch with reader to handle SSE manually if needed, or EventSource. 
                // But for full control (and headers if we had Auth), EventSource is simpler for GET.
                // However, the backend implementation uses SSE format.

                const eventSource = new EventSource(url);
                const messageEl = appendAIMessage(); // Create empty bubble
                loading.classList.add('hidden'); // Hide "Thinking dots" as we have a bubble

                let isThinking = false;

                eventSource.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'token') {
                            accumulatedText += data.content;
                            // Only update every few tokens or frame for performance? 
                            // Marked is fast enough for small text.
                            messageEl.innerHTML = marked.parse(accumulatedText);
                            scrollToBottom();
                        } else if (data.type === 'error') {
                            showToast(data.content, 'error');
                            eventSource.close();
                            finalize();
                        } else if (data.type === 'end') {
                            eventSource.close();
                            finalize();
                        }
                    } catch (e) {
                        console.error("Parse error", e);
                    }
                };

                eventSource.onerror = function (err) {
                    console.error("EventSource failed:", err);
                    eventSource.close();
                    if (accumulatedText.length === 0) {
                        showToast("Impossible de joindre le serveur. Veuillez r√©essayer.", 'error');
                        loading.classList.add('hidden');
                        // Remove the empty bubble if it failed immediately
                        messageEl.parentElement.remove();
                    }
                    finalize();
                };

            } catch (error) {
                console.error("Error:", error);
                showToast("Une erreur inattendue est survenue.", 'error');
                loading.classList.add('hidden');
                finalize();
            }

            function finalize() {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
                loading.classList.add('hidden');
            }
        }

        // Add fading animation styles
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.4s ease-out forwards;
            }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>

</html>